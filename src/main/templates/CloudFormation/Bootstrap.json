{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CloudWrap Bootstrap: Roles and Optional State Bucket",
  "Parameters": {
    "BootstrapUserArn": {
      "Type": "String",
      "Description": "The ARN of the IAM user allowed to assume these roles."
    },
    "CreateNewBucket": {
      "Type": "String",
      "Default": "Yes",
      "AllowedValues": ["Yes", "No"],
      "Description": "Set to 'No' if you already have a state bucket."
    },
    "ExistingBucketName": {
      "Type": "String",
      "Default": "",
      "Description": "If CreateNewBucket is No, provide the existing bucket name here (for output consistency)."
    },
    "TargetBucketName": {
      "Type": "String",
      "Description": "The exact name to force for the State Bucket"
    },
    "ConnectionNonce": {
      "Type": "String",
      "Default": "1",
      "Description": "Increment this to force-recreate the connection if it was deleted manually."
    }
  },
  "Conditions": {
    "ShouldCreateBucket": { "Fn::Equals": [{ "Ref": "CreateNewBucket" }, "Yes"] }
  },
  "Resources": {
    "CloudWrapStateBucket": {
      "Type": "AWS::S3::Bucket",
      "Condition": "ShouldCreateBucket",
      "Properties": {
        "BucketName": { "Ref": "TargetBucketName" },
        "VersioningConfiguration": { "Status": "Enabled" },
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            { "ServerSideEncryptionByDefault": { "SSEAlgorithm": "AES256" } }
          ]
        },
        "PublicAccessBlockConfiguration": {
          "BlockPublicAcls": true,
          "BlockPublicPolicy": true,
          "IgnorePublicAcls": true,
          "RestrictPublicBuckets": true
        }
      }
    },
    "CloudWrapProvisioningRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": { "Fn::Sub": "CloudWrap-Provisioning-Role-${AWS::Region}" },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "AWS": { "Ref": "BootstrapUserArn" } },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AdministratorAccess"]
      }
    },
    "CloudWrapServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": { "Fn::Sub": "CloudWrap-Service-Role-${AWS::Region}" },
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "AWS": { "Ref": "BootstrapUserArn" } },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonEC2FullAccess",
          "arn:aws:iam::aws:policy/AmazonRDSFullAccess",
          "arn:aws:iam::aws:policy/AmazonS3FullAccess",
          "arn:aws:iam::aws:policy/AWSBillingReadOnlyAccess"
        ],
        "Policies": [
          {
            "PolicyName": "CloudWrapExtendedAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ce:Get*",
                    "ce:Describe*",
                    "codeconnections:GetConnection",
                    "codeconnections:CreateConnection",
                    "codebuild:BatchGetBuilds",
                    "codepipeline:*"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "GithubConnection": {
      "Type": "AWS::CodeStarConnections::Connection",
      "Properties": {
        "ConnectionName": { "Fn::Sub": "CloudWrap-GitHub-${ConnectionNonce}" },
        "ProviderType": "GitHub"
      }
    }
  },
  "Outputs": {
    "BucketName": {
      "Value": {
        "Fn::If": [
          "ShouldCreateBucket",
          { "Ref": "CloudWrapStateBucket" },
          { "Ref": "ExistingBucketName" }
        ]
      },
      "Description": "The S3 bucket for OpenTofu state"
    },
    "TfRoleArn": {
      "Value": { "Fn::GetAtt": ["CloudWrapProvisioningRole", "Arn"] }
    },
    "ServiceRoleArn": {
      "Value": { "Fn::GetAtt": ["CloudWrapServiceRole", "Arn"] }
    },
    "GithubConnectionArn": {
      "Description": "The ARN of the CodeStar Connection",
      "Value": { "Ref": "GithubConnection" }
    }
  }
}
